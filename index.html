<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0a0a0a">
  <title>LuxeNails AR Studio™ — Try Before You Book</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Nails</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css" />
  <style>
    :root {
      --bg: #0a0a0a;
      --gold: #d4af37;
      --text: #ffffff;
      --card: rgba(20, 20, 20, 0.92);
      --blur: blur(28px);
      --shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
    }
    [data-theme="light"] {
      --bg: #fafafa;
      --gold: #b8941f;
      --text: #1a1a1a;
      --card: rgba(255, 255, 255, 0.95);
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    body {
      background: var(--bg); overflow: hidden; font-family: 'Satoshi', sans-serif; color: var(--text);
      transition: background 0.5s ease, color 0.5s ease;
    }
    #video, #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    #video { z-index: 1; display: none; }
    #canvas { z-index: 2; display: none; }

    /* === ПРЕМІУМ UI === */
    .control-btn {
      position: fixed; width: 58px; height: 58px; border-radius: 50%;
      background: var(--card); backdrop-filter: var(--blur); border: 1.5px solid rgba(212, 175, 55, 0.25);
      color: var(--gold); font-size: 23px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 100; transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 5px 22px rgba(0, 0, 0, 0.3);
    }
    .control-btn:active { transform: scale(0.95); }
    .control-btn:hover { transform: scale(1.14); border-color: var(--gold); box-shadow: 0 10px 35px rgba(212, 175, 55, 0.35); }
    #uploadBtn { top: 18px; left: 18px; }
    #shapeBtn { top: 18px; right: 18px; }
    #themeBtn { top: 18px; left: 50%; transform: translateX(-50%); }
    #salonBtn { top: 18px; right: 90px; font-size: 18px; }
    #shopBtn {
      bottom: 18px; right: 18px; background: linear-gradient(135deg, var(--gold), #b8941f); color: #0a0a0a;
      font-weight: 700; font-size: 16px; border: none; box-shadow: 0 0 0 3px var(--bg), 0 12px 35px rgba(212, 175, 55, 0.55);
    }

    #modeToggle { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); z-index: 100; background: var(--card); backdrop-filter: var(--blur); padding: 11px; border-radius: 30px; border: 1px solid rgba(212, 175, 55, 0.18); display: flex; gap: 11px; }
    .mode-option { width: 42px; height: 42px; border-radius: 50%; background: rgba(40, 40, 40, 0.85); display: flex; align-items: center; justify-content: center; font-size: 19px; cursor: pointer; transition: all 0.35s ease; border: 1.5px solid transparent; }
    .mode-option.active { background: var(--gold); color: #0a0a0a; transform: scale(1.18); box-shadow: 0 0 22px rgba(212, 175, 55, 0.5); }

    #designPicker, #shapePicker { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); display: flex; gap: 18px; z-index: 100; background: var(--card); backdrop-filter: var(--blur); padding: 22px 26px; border-radius: 34px; border: 1px solid rgba(212, 175, 55, 0.16); max-width: 92vw; overflow-x: auto; scrollbar-width: none; }
    #shapePicker { bottom: 135px; display: none; }
    #designPicker::-webkit-scrollbar, #shapePicker::-webkit-scrollbar { display: none; }

    .design-btn, .shape-btn {
      width: 80px; height: 80px; border-radius: 22px; border: 2.5px solid rgba(255, 255, 255, 0.16); background: #1a1a1a; cursor: pointer;
      transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); flex-shrink: 0; object-fit: cover; position: relative; overflow: hidden;
    }
    .design-btn:hover, .shape-btn:hover { transform: scale(1.12); border-color: var(--gold); }
    .design-btn.selected, .shape-btn.selected { border-color: var(--gold); box-shadow: 0 0 0 3.5px var(--gold), 0 12px 35px rgba(212, 175, 55, 0.45); transform: scale(1.18); }

    .design-label {
      position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; pointer-events: none; opacity: 0; transition: opacity 0.3s;
    }
    .design-btn:hover .design-label { opacity: 1; }

    /* === МОДАЛИ === */
    #onboarding, #bookingModal, #salonModal, #uploadModal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); backdrop-filter: var(--blur);
      padding: 36px; border-radius: 30px; border: 1px solid rgba(212, 175, 55, 0.22); z-index: 1000; display: none; color: var(--text); text-align: center;
      width: 90%; max-width: 460px; box-shadow: var(--shadow);
    }
    .modal.show { display: block; animation: modalAppear 0.55s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

    .modal h3 { margin: 0; font-weight: 700; color: var(--gold); font-size: 24px; }
    .modal p { margin: 16px 0; color: #bbb; font-size: 15px; line-height: 1.5; }

    .modal-btn {
      padding: 15px 30px; margin: 12px 6px; border: none; border-radius: 22px; font-weight: 600; cursor: pointer; transition: all 0.35s ease; font-size: 16px;
    }
    #bookNow, #saveDesign { background: linear-gradient(135deg, var(--gold), #b8941f); color: #0a0a0a; }
    #closeModal, #closeBooking, #closeOnboarding { background: rgba(40, 40, 40, 0.85); color: var(--gold); border: 1.5px solid rgba(212, 175, 55, 0.3); }

    #loading { position: fixed; top:  zusamm; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: var(--gold); font-size: 30px; text-align: center; padding: 35px; gap: 32px; }
    .loader { width: 75px; height: 75px; border: 4.5px solid rgba(212, 175, 55, 0.3); border-top: 4.5px solid var(--gold); border-radius: 50%; animation: spin 1.1s linear infinite; box-shadow: 0 0 28px rgba(212, 175, 55, 0.35); }

    .indicator { position: fixed; left: 50%; transform: translateX(-50%); background: var(--card); color: var(--gold); padding: 15px 24px; border-radius: 24px; display: none; align-items: center; gap: 14px; z-index: 99; font-size: 16px; border: 1px solid rgba(212, 175, 55, 0.2); backdrop-filter: var(--blur); }
    #handIndicator { top: 170px; }
    .indicator.show { display: flex; animation: indicatorAppear 0.45s ease; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes modalAppear { from { opacity: 0; transform: translate(-50%, -46%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    @keyframes indicatorAppear { from { opacity: 0; transform: translateX(-50%) translateY(-12px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    @media (max-width: 768px) {
      .control-btn { width: 54px; height: 54px; font-size: 21px; }
      .design-btn, .shape-btn { width: 72px; height: 72px; }
      .modal { padding: 28px; }
    }
  </style>
</head>
<body data-theme="dark">
  <div id="loading">
    <div class="loader"></div>
    <div style="font-weight: 700; margin-bottom: 14px;">LuxeNails AR Studio™</div>
    <p style="color: #ccc; font-size: 18px;">Show your hand to the camera</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <button id="uploadBtn" class="control-btn">Upload</button>
  <button id="shapeBtn" class="control-btn">Shape</button>
  <button id="themeBtn" class="control-btn">Light/Dark</button>
  <button id="salonBtn" class="control-btn">Salon</button>
  <button id="shopBtn" class="control-btn">Book</button>

  <div id="modeToggle">
    <div class="mode-option active" id="applyAllOpt">All</div>
    <div class="mode-option" id="selectFingerOpt">Finger</div>
  </div>

  <div id="shapePicker"></div>
  <div id="designPicker"></div>

  <!-- ONBOARDING -->
  <div id="onboarding" class="modal show">
    <h3>Welcome to LuxeNails</h3>
    <p>Try professional nail designs in real-time AR before booking your appointment with top artists.</p>
    <button id="startOnboarding" class="modal-btn">Get Started</button>
  </div>

  <!-- BOOKING -->
  <div id="bookingModal" class="modal">
    <h3>Book Your Look</h3>
    <p id="bookingDesign"></p>
    <div id="calendly-inline-widget" style="min-height:420px;margin:22px 0;"></div>
    <button id="closeBooking" class="modal-btn">Close</button>
  </div>

  <!-- UPLOAD -->
  <div id="uploadModal" class="modal">
    <h3>Upload Your Design</h3>
    <p>Best: PNG with transparent background (max 5MB)</p>
    <input type="file" id="imageUpload" accept="image/*" style="margin:20px 0;padding:16px;border:2px dashed rgba(212,175,55,0.3);border-radius:16px;background:rgba(30,30,30,0.6);color:white;width:100%;cursor:pointer;">
    <button id="saveDesign" class="modal-btn">Save Design</button>
    <button id="closeModal" class="modal-btn">Cancel</button>
  </div>

  <!-- SALON MODE -->
  <div id="salonModal" class="modal">
    <h3>Salon Mode</h3>
    <p>Admin access for staff only.</p>
    <input type="password" id="salonPass" placeholder="Enter code" style="margin:15px 0;padding:14px;border-radius:16px;border:1px solid rgba(212,175,55,0.3);background:rgba(30,30,30,0.6);color:white;width:100%;">
    <button id="enterSalon" class="modal-btn">Enter</button>
  </div>

  <div id="handIndicator" class="indicator">
    <span>Hand</span>
    <span>Show your hand</span>
  </div>

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js" } }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";

    // === ПРОФЕСІЙНІ ДИЗАЙНИ ===
    const PRO_DESIGNS = [
      { id: 'chrome_mirror', name: 'Chrome Mirror', artist: '@nailgod', price: '$95', url: 'https://i.imgur.com/3kL5mP2.png' },
      { id: 'velvet_cat_eye', name: 'Velvet Cat Eye', artist: '@luxenails_pro', price: '$120', url: 'https://i.imgur.com/8vX9nR1.png' },
      { id: 'swarovski_3d', name: '3D Swarovski', artist: '@crystalnails', price: '$250', url: 'https://i.imgur.com/1qA2bC3.png' },
      { id: 'french_luxe', name: 'French Luxe', artist: '@parisnails', price: '$85', url: 'https://i.imgur.com/5tY7uV9.png' },
      { id: 'marble_gold', name: 'Marble Gold', artist: '@artnails', price: '$110', url: 'https://i.imgur.com/9pL3mX5.png' }
    ];

    const CONFIG = {
      SMOOTHING_FACTOR: 0.82,
      HAND_NOT_DETECTED_THRESHOLD: 10,
      NAIL_SCALE_FACTORS: { thumb: 0.45, index: 0.56, middle: 0.58, ring: 0.56, pinky: 0.44 },
      MIN_SIZE: 34, MAX_SIZE: 98,
      WRIST_REF: 0.1, SCALE_SENS: 2.1,
      MAX_SCALE: 2.3, MIN_SCALE: 0.58
    };

    const FINGER_INDICES = {
      thumb: { tip: 4, mcp: 2, pip: 3 },
      index: { tip: 8, mcp: 5, pip: 6 },
      middle: { tip: 12, mcp: 9, pip: 10 },
      ring: { tip: 16, mcp: 13, pip: 14 },
      pinky: { tip: 20, mcp: 17, pip: 18 }
    };
    const FINGER_KEYS = Object.keys(FINGER_INDICES);
    const NAIL_SHAPES = ['oval', 'almond', 'squoval', 'triangular', 'natural'];

    const state = {
      currentDesign: "chrome_mirror",
      currentShape: 'oval',
      isApplyAll: true,
      selectedFingerIndex: -1,
      lastLandmarks: null,
      smoothedLandmarks: null,
      handNotDetectedCount: 0,
      currentHandSize: 1.0,
      showShapePicker: false,
      isLeftHand: false,
      theme: 'dark',
      isSalonMode: false
    };

    const el = {
      video: document.getElementById("video"),
      canvas: document.getElementById("canvas"),
      loading: document.getElementById("loading"),
      uploadBtn: document.getElementById("uploadBtn"),
      shapeBtn: document.getElementById("shapeBtn"),
      themeBtn: document.getElementById("themeBtn"),
      salonBtn: document.getElementById("salonBtn"),
      shopBtn: document.getElementById("shopBtn"),
      applyAllOpt: document.getElementById("applyAllOpt"),
      selectFingerOpt: document.getElementById("selectFingerOpt"),
      designPicker: document.getElementById("designPicker"),
      shapePicker: document.getElementById("shapePicker"),
      onboarding: document.getElementById("onboarding"),
      startOnboarding: document.getElementById("startOnboarding"),
      bookingModal: document.getElementById("bookingModal"),
      bookingDesign: document.getElementById("bookingDesign"),
      closeBooking: document.getElementById("closeBooking"),
      uploadModal: document.getElementById("uploadModal"),
      imageUpload: document.getElementById("imageUpload"),
      saveDesign: document.getElementById("saveDesign"),
      closeModal: document.getElementById("closeModal"),
      salonModal: document.getElementById("salonModal"),
      salonPass: document.getElementById("salonPass"),
      enterSalon: document.getElementById("enterSalon"),
      handIndicator: document.getElementById("handIndicator")
    };

    const nailTextures = {}, nails = {}, cuticles = {}, crystals = {};
    let scene, camera, renderer, handLandmarker, maskWorker;

    // === PBR ШЕЙДЕР ===
    const NAIL_SHADER = {
      vertexShader: `
        varying vec2 vUv; varying vec3 vNormal; varying vec3 vViewPosition; varying vec3 vWorldPosition;
        void main() {
          vUv = uv;
          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
          vViewPosition = -mvPosition.xyz;
          vNormal = normalize(normalMatrix * normal);
          vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
          gl_Position = projectionMatrix * mvPosition;
        }
      `,
      fragmentShader: `
        uniform sampler2D map; uniform float roughness; uniform float metalness; uniform float time;
        varying vec2 vUv; varying vec3 vNormal; varying vec3 vViewPosition; varying vec3 vWorldPosition;
        void main() {
          vec4 tex = texture2D(map, vUv); if (tex.a < 0.1) discard;
          vec3 color = tex.rgb;
          vec3 viewDir = normalize(vViewPosition);
          vec3 lightDir = normalize(vec3(0.5, 1.0, 0.5));
          vec3 refl = reflect(-lightDir, vNormal);
          float spec = pow(max(dot(refl, viewDir), 0.0), 128.0 * (1.0 - roughness));
          vec3 fresnel = mix(vec3(0.04), color, pow(1.0 - dot(viewDir, vNormal), 3.0));
          color = color * 0.7 + vec3(1.0) * spec * 0.8 + fresnel * 0.5;
          float rim = pow(1.0 - dot(viewDir, vNormal), 2.8) * 0.6; color += vec3(1.0, 0.96, 0.9) * rim;
          gl_FragColor = vec4(color, tex.a);
        }
      `
    };

    class LuxeNailsPRO {
      async init() {
        this.setupEvents();
        await this.setupCamera();
        await this.initWebGL();
        await this.setupHandTracking();
        await this.loadProDesigns();
        this.buildUI();
        this.hideLoading();
        this.startLoop();
        this.initWorker();
        this.loadCalendly();
      }

      initWorker() {
        const workerCode = `
          self.onmessage = async e => {
            const {imgData, shape} = e.data;
            const c = new OffscreenCanvas(256, 384);
            const ctx = c.getContext('2d');
            const img = new Image();
            img.src = imgData;
            await new Promise(r => img.onload = r);
            ctx.fillStyle = 'white';
            ctx.beginPath();
            const w = 256, h = 384, cx = w/2, cy = h/2;
            if (shape === 'oval') ctx.ellipse(cx, cy-20, 100, 150, 0, 0, Math.PI*2);
            else if (shape === 'almond') { ctx.moveTo(cx,50); ctx.bezierCurveTo(cx+90,80,cx+110,160,cx,340); ctx.bezierCurveTo(cx-110,160,cx-90,80,cx,50); }
            else if (shape === 'squoval') ctx.roundRect(60,60,136,264,50);
            else if (shape === 'triangular') { ctx.moveTo(cx,40); ctx.lineTo(cx+100,320); ctx.lineTo(cx-100,320); ctx.closePath(); }
            else ctx.roundRect(60,60,136,264,50);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(img, 0, 0, 256, 384);
            self.postMessage(c.transferToImageBitmap());
          };
        `;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        maskWorker = new Worker(URL.createObjectURL(blob));
      }

      setupEvents() {
        el.uploadBtn.onclick = () => el.uploadModal.classList.add('show');
        el.shapeBtn.onclick = () => {
          state.showShapePicker = !state.showShapePicker;
          el.shapePicker.style.display = state.showShapePicker ? 'flex' : 'none';
        };
        el.themeBtn.onclick = () => {
          state.theme = state.theme === 'dark' ? 'light' : 'dark';
          document.body.dataset.theme = state.theme;
          localStorage.setItem('theme', state.theme);
        };
        el.salonBtn.onclick = () => el.salonModal.classList.add('show');
        el.enterSalon.onclick = () => {
          if (el.salonPass.value === 'luxenails2025') {
            state.isSalonMode = true;
            el.salonModal.classList.remove('show');
            alert('Salon Mode Activated');
          }
        };
        el.shopBtn.onclick = () => {
          const design = PRO_DESIGNS.find(d => d.id === state.currentDesign);
          el.bookingDesign.textContent = `${design.name} by ${design.artist} — ${design.price}`;
          el.bookingModal.classList.add('show');
        };
        el.closeBooking.onclick = () => el.bookingModal.classList.remove('show');
        el.closeModal.onclick = () => { el.uploadModal.classList.remove('show'); el.imageUpload.value = ''; };
        el.startOnboarding.onclick = () => el.onboarding.classList.remove('show');
        el.applyAllOpt.onclick = () => this.setMode(true);
        el.selectFingerOpt.onclick = () => this.setMode(false);
        el.canvas.onclick = e => this.handleClick(e);
        el.saveDesign.onclick = () => this.uploadDesign();
      }

      async uploadDesign() {
        const file = el.imageUpload.files[0];
        if (!file || file.size > 5*1024*1024) return alert("Max 5MB");
        el.saveDesign.disabled = true; el.saveDesign.textContent = "Processing...";
        const reader = new FileReader();
        reader.onload = async () => {
          const result = await new Promise(resolve => {
            maskWorker.onmessage = e => resolve(e.data);
            maskWorker.postMessage({ imgData: reader.result, shape: state.currentShape });
          });
          const tex = new THREE.CanvasTexture(result);
          const id = `custom_${Date.now()}`;
          nailTextures[id] = tex;
          state.currentDesign = id;
          this.addCustomDesign(reader.result);
          el.uploadModal.classList.remove('show');
          el.imageUpload.value = '';
          el.saveDesign.disabled = false; el.saveDesign.textContent = "Save Design";
        };
        reader.readAsDataURL(file);
      }

      addCustomDesign(url) {
        const btn = document.createElement('div');
        btn.className = 'design-btn selected custom-design';
        btn.style.backgroundImage = `url(${url})`;
        btn.style.backgroundSize = 'cover';
        btn.onclick = () => {
          state.currentDesign = Object.keys(nailTextures).find(k => nailTextures[k].image.src.includes(url.split('/').pop()));
          document.querySelectorAll('.design-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
        el.designPicker.insertBefore(btn, el.designPicker.firstChild);
      }

      loadCalendly() {
        if (window.Calendly) {
          Calendly.initInlineWidget({
            url: 'https://calendly.com/luxenails-ar/30min',
            parentElement: document.getElementById('calendly-inline-widget')
          });
        }
      }

      async loadProDesigns() {
        const loader = new THREE.TextureLoader();
        for (const design of PRO_DESIGNS) {
          nailTextures[design.id] = await loader.loadAsync(design.url);
        }
      }

      async initWebGL() {
        scene = new THREE.Scene();
        camera = new THREE.OrthographicCamera(-innerWidth/2, innerWidth/2, innerHeight/2, -innerHeight/2, 0.1, 1000);
        camera.position.z = 10;
        renderer = new THREE.WebGLRenderer({ canvas: el.canvas, alpha: true, antialias: true, powerPreference: "high-performance" });
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        renderer.setSize(innerWidth, innerHeight);
        this.create3DNails();
      }

      create3DNails() {
        const mat = new THREE.ShaderMaterial({
          uniforms: {
            map: { value: null },
            roughness: { value: 0.04 },
            metalness: { value: 0.0 },
            time: { value: 0 }
          },
          vertexShader: NAIL_SHADER.vertexShader,
          fragmentShader: NAIL_SHADER.fragmentShader,
          transparent: true,
          side: THREE.DoubleSide
        });

        FINGER_KEYS.forEach(key => {
          const geom = new THREE.CylinderGeometry(0.19, 0.13, 1.35, 18, 1, false, 0, Math.PI);
          geom.rotateX(Math.PI / 2);
          const mesh = new THREE.Mesh(geom, mat.clone());
          mesh.visible = false; mesh.frustumCulled = false;
          nails[key] = mesh; scene.add(mesh);

          const cuticleGeom = new THREE.RingGeometry(0.13, 0.23, 18);
          const cuticleMat = new THREE.MeshBasicMaterial({ color: 0xf4c2c2, transparent: true, opacity: 0.75, side: THREE.DoubleSide });
          const cuticle = new THREE.Mesh(cuticleGeom, cuticleMat);
          cuticles[key] = cuticle; scene.add(cuticle);
        });
      }

      async setupHandTracking() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "GPU" },
          runningMode: "VIDEO",
          numHands: 1
        });
      }

      async setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: 1280, height: 720 }
        });
        el.video.srcObject = stream;
        await new Promise(r => el.video.onloadedmetadata = r);
        el.video.play();
      }

      buildUI() {
        el.designPicker.innerHTML = '';
        PRO_DESIGNS.forEach(d => {
          const btn = document.createElement('div');
          btn.className = `design-btn ${d.id === state.currentDesign ? 'selected' : ''}`;
          btn.style.backgroundImage = `url(${d.url})`;
          btn.style.backgroundSize = 'cover';
          const label = document.createElement('div');
          label.className = 'design-label';
          label.textContent = d.name;
          btn.appendChild(label);
          btn.onclick = () => {
            state.currentDesign = d.id;
            document.querySelectorAll('.design-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          };
          el.designPicker.appendChild(btn);
        });

        el.shapePicker.innerHTML = '';
        NAIL_SHAPES.forEach(s => {
          const b = document.createElement('div');
          b.className = `shape-btn ${s === state.currentShape ? 'selected' : ''}`;
          b.textContent = s.charAt(0).toUpperCase() + s.slice(1).replace('triangular', 'Pointed').replace('squoval', 'Squoval');
          b.onclick = () => {
            state.currentShape = s;
            document.querySelectorAll('.shape-btn').forEach(x => x.classList.remove('selected'));
            b.classList.add('selected');
          };
          el.shapePicker.appendChild(b);
        });
      }

      setMode(all) {
        state.isApplyAll = all;
        el.applyAllOpt.classList.toggle('active', all);
        el.selectFingerOpt.classList.toggle('active', !all);
      }

      startLoop() {
        const loop = () => {
          this.detect();
          this.render();
          requestAnimationFrame(loop);
        };
        loop();
      }

      detect() {
        if (!handLandmarker || el.video.readyState < 2) return;
        const res = handLandmarker.detectForVideo(el.video, performance.now());
        if (res.landmarks?.length) {
          state.handNotDetectedCount = 0;
          el.handIndicator.classList.remove('show');
          const lm = res.landmarks[0];
          state.isLeftHand = res.handednesses[0][0].displayName === "Left";
          state.lastLandmarks = this.smooth(lm);
          this.calcSize(lm);
        } else if (++state.handNotDetectedCount > CONFIG.HAND_NOT_DETECTED_THRESHOLD) {
          el.handIndicator.classList.add('show');
          this.hideAll();
        }
      }

      smooth(lm) {
        if (!state.smoothedLandmarks) state.smoothedLandmarks = lm.map(p => ({...p}));
        state.smoothedLandmarks.forEach((s, i) => {
          s.x = this.lerp(s.x, lm[i].x, CONFIG.SMOOTHING_FACTOR);
          s.y = this.lerp(s.y, lm[i].y, CONFIG.SMOOTHING_FACTOR);
        });
        return state.smoothedLandmarks;
      }

      lerp(a, b, t) { return a + (b - a) * t; }

      calcSize(lm) {
        const d = Math.hypot(lm[0].x - lm[1].x, lm[0].y - lm[1].y);
        let s = d / CONFIG.WRIST_REF * CONFIG.SCALE_SENS;
        s = Math.max(CONFIG.MIN_SCALE, Math.min(CONFIG.MAX_SCALE, s));
        state.currentHandSize = s;
      }

      render() {
        if (!state.lastLandmarks) return;
        const flip = state.isLeftHand ? -1 : 1;
        FINGER_KEYS.forEach((k, i) => {
          if (!state.isApplyAll && i !== state.selectedFingerIndex) {
            nails[k].visible = false;
            cuticles[k].visible = false;
            return;
          }
          this.updateNail(k, flip);
          nails[k].visible = true;
          cuticles[k].visible = true;
        });
        renderer.render(scene, camera);
      }

      updateNail(key, flip) {
        const lm = state.lastLandmarks;
        const { tip, pip, mcp } = FINGER_INDICES[key];
        const t = lm[tip], p = lm[pip], m = lm[mcp];
        const off = { x: 0, y: -0.02 };
        const x = (t.x + off.x * flip) * innerWidth;
        const y = (1 - (t.y + off.y)) * innerHeight;
        const len = Math.hypot((t.x - p.x) * innerWidth, (t.y - p.y) * innerHeight);
        let size = len * CONFIG.NAIL_SCALE_FACTORS[key] * state.currentHandSize;
rando        size = Math.max(CONFIG.MIN_SIZE, Math.min(CONFIG.MAX_SIZE, size));
        const angle = Math.atan2(t.y - p.y, (t.x - p.x) * flip);

        const nail = nails[key];
        nail.position.set(x - innerWidth/2, y - innerHeight/2, 0);
        nail.scale.set(size * flip, size, 1);
        nail.rotation.z = angle;

        const cuticle = cuticles[key];
        const cx = (m.x * innerWidth) - innerWidth/2;
        const cy = (1 - m.y) * innerHeight - innerHeight/2;
        cuticle.position.set(cx, cy, -0.01);
        cuticle.scale.set(size * 0.8, size * 0.8, 1);
        cuticle.rotation.z = angle;

        if (nailTextures[state.currentDesign]) {
          nail.material.uniforms.map.value = nailTextures[state.currentDesign];
          nail.material.uniforms.time.value = performance.now() * 0.001;
          nail.material.needsUpdate = true;
        }
      }

      handleClick(e) {
        if (state.isApplyAll || !state.lastLandmarks) return;
        const rect = el.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        let min = Infinity, idx = -1;
        FINGER_KEYS.forEach((k, i) => {
          const tip = state.lastLandmarks[FINGER_INDICES[k].tip];
          const d = Math.hypot(x - tip.x * innerWidth, y - tip.y * innerHeight);
          if (d < min && d < innerWidth * 0.13) { min = d; idx = i; }
        });
        state.selectedFingerIndex = idx;
      }

      hideAll() {
        FINGER_KEYS.forEach(k => {
          nails[k].visible = false;
          cuticles[k].visible = false;
        });
        renderer.render(scene, camera);
      }

      hideLoading() {
        el.loading.style.display = 'none';
        el.video.style.display = 'block';
        el.canvas.style.display = 'block';
      }
    }

    // Calendly
    const calendlyScript = document.createElement('script');
    calendlyScript.src = 'https://assets.calendly.com/assets/external/widget.js';
    document.head.appendChild(calendlyScript);

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.dataset.theme = savedTheme;
      state.theme = savedTheme;
      new LuxeNailsPRO().init();
    });
  </script>
</body>
</html>
